<div class="container-fluid">
  <app-page-title [title]="title" [icon]="icon"></app-page-title>

  <!-- Loading spinner -->
  <div *ngIf="isLoading" class="text-center my-4">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Caricamento...</span>
    </div>
  </div>

  <!-- Content -->
  <div *ngIf="!isLoading">
    <!-- Filtri -->
    <div class="filters-container mb-3">
      <div class="row">
        <div class="col-md-3">
          <div class="form-group">
            <label for="search">Cerca</label>
            <input
              type="text"
              id="search"
              class="form-control"
              placeholder="Nome, cognome, email o codice..."
              [(ngModel)]="searchTerm"
              (keyup)="onSearchChange()"
            />
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <label for="reparto">Reparto</label>
            <select
              id="reparto"
              class="form-control"
              [(ngModel)]="selectedReparto"
              (change)="onRepartoChange()"
            >
              <option value="">Tutti</option>
              <option *ngFor="let reparto of reparti" [value]="reparto">
                {{ reparto }}
              </option>
            </select>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <label for="commerciale">Area Commerciale</label>
            <select
              id="commerciale"
              class="form-control"
              [(ngModel)]="selectedCommerciale"
              (change)="onCommercialeChange()"
            >
              <option value="">Tutte</option>
              <option
                *ngFor="let commerciale of commerciali"
                [value]="commerciale"
              >
                {{ commerciale }}
              </option>
            </select>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <div class="form-check mt-4">
              <input
                type="checkbox"
                id="soloAttivi"
                class="form-check-input"
                [(ngModel)]="soloAttivi"
                (change)="onAttivoChange()"
              />
              <label class="form-check-label" for="soloAttivi"
                >Solo Attivi</label
              >
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-group">
            <label>&nbsp;</label>
            <div class="d-block">
              <button class="btn btn-secondary btn-sm" (click)="clearFilters()">
                <i class="fa-solid fa-filter-circle-xmark"></i> Pulisci Filtri
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabella -->
    <div class="table-container">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Codice</th>
            <th>Nome Completo</th>
            <th>Email</th>
            <th>Reparto</th>
            <th>Area Commerciale</th>
            <th>Ruolo</th>
            <th>Stato</th>
            <th class="text-center">Azioni</th>
          </tr>
        </thead>
        <tbody>
          @if (filteredDipendenti.length === 0) {
            <tr>
              <td colspan="8" class="text-center text-muted">
                Nessun dipendente trovato con i filtri applicati
              </td>
            </tr>
          }
          @for (dipendente of filteredDipendenti; track dipendente.id) {
            <tr [class.table-secondary]="!dipendente.attivo">
              <td>
                <strong>{{ dipendente.codiceDipendente }}</strong>
              </td>
              <td>{{ getNomeCompleto(dipendente) }}</td>
              <td>{{ dipendente.email }}</td>
              <td>
                <span *ngIf="dipendente.reparto; else noReparto">{{
                  dipendente.reparto
                }}</span>
                <ng-template #noReparto
                  ><em class="text-muted">Non specificato</em></ng-template
                >
              </td>
              <td>
                <span *ngIf="dipendente.commerciale; else noCommerciale">{{
                  dipendente.commerciale
                }}</span>
                <ng-template #noCommerciale
                  ><em class="text-muted">Non specificato</em></ng-template
                >
              </td>
              <td>
                <span *ngIf="dipendente.ruolo; else noRuolo">{{
                  dipendente.ruolo
                }}</span>
                <ng-template #noRuolo
                  ><em class="text-muted">Non specificato</em></ng-template
                >
              </td>
              <td>
                <span
                  class="badge"
                  [class.bg-success]="dipendente.attivo"
                  [class.bg-secondary]="!dipendente.attivo"
                >
                  {{ dipendente.attivo ? 'Attivo' : 'Disabilitato' }}
                </span>
              </td>
              <td class="align-middle text-center">
                <button
                  class="btn btn-primary btn-action me-1"
                  (click)="modifica(dipendente.id)"
                  title="Modifica dipendente"
                >
                  <i class="fa-solid fa-pen-to-square"></i>
                </button>
                <button
                  class="btn btn-danger btn-action"
                  (click)="elimina(dipendente.id)"
                  title="Disabilita dipendente"
                  [disabled]="!dipendente.attivo"
                >
                  <i class="fa-solid fa-user-slash"></i>
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Statistiche -->
    <div class="stats-container mb-3">
      <div class="row">
        <div class="col-md-12">
          <small class="text-muted">
            Visualizzati {{ filteredDipendenti.length }} di
            {{ dipendenti.length }} dipendenti totali
          </small>
        </div>
      </div>
    </div>

    <!-- Pulsante Aggiungi -->
    <div class="button-container">
      <button
        class="btn btn-success btn-sm px-4"
        (click)="aggiungi()"
        title="Aggiungi nuovo dipendente"
      >
        Aggiungi Dipendente
        <i class="fa-solid fa-plus ms-1"></i>
      </button>
    </div>
  </div>

  <!-- Modal per Aggiungi/Modifica -->
  <app-modal
    *ngIf="isModalOpen"
    [isOpen]="isModalOpen"
    [title]="modalTitle"
    (closeModal)="closeModal()"
  >
    <div class="modal-body-content">
      <form [formGroup]="dipendenteForm" (ngSubmit)="onSubmit()">
        <div class="row">
          <!-- Nome -->
          <div class="col-md-6 mb-3">
            <label for="nome" class="form-label">Nome *</label>
            <input
              type="text"
              id="nome"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('nome')"
              formControlName="nome"
              placeholder="Inserisci il nome"
            />
            <div class="invalid-feedback" *ngIf="isFieldInvalid('nome')">
              {{ getFieldError('nome') }}
            </div>
          </div>

          <!-- Cognome -->
          <div class="col-md-6 mb-3">
            <label for="cognome" class="form-label">Cognome *</label>
            <input
              type="text"
              id="cognome"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('cognome')"
              formControlName="cognome"
              placeholder="Inserisci il cognome"
            />
            <div class="invalid-feedback" *ngIf="isFieldInvalid('cognome')">
              {{ getFieldError('cognome') }}
            </div>
          </div>

          <!-- Email -->
          <div class="col-md-6 mb-3">
            <label for="email" class="form-label">Email *</label>
            <input
              type="email"
              id="email"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('email')"
              formControlName="email"
              placeholder="nome.cognome@azienda.com"
            />
            <div class="invalid-feedback" *ngIf="isFieldInvalid('email')">
              {{ getFieldError('email') }}
            </div>
          </div>

          <!-- Codice Dipendente -->
          <div class="col-md-6 mb-3">
            <label for="codiceDipendente" class="form-label"
              >Codice Dipendente *</label
            >
            <input
              type="text"
              id="codiceDipendente"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('codiceDipendente')"
              formControlName="codiceDipendente"
              placeholder="Es. MR123"
            />
            <div
              class="invalid-feedback"
              *ngIf="isFieldInvalid('codiceDipendente')"
            >
              {{ getFieldError('codiceDipendente') }}
            </div>
          </div>

          <!-- Reparto -->
          <div class="col-md-6 mb-3">
            <label for="repartoForm" class="form-label">Reparto</label>
            <input
              type="text"
              id="repartoForm"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('reparto')"
              formControlName="reparto"
              placeholder="Es. IT, HR, Sales"
            />
            <div class="invalid-feedback" *ngIf="isFieldInvalid('reparto')">
              {{ getFieldError('reparto') }}
            </div>
          </div>

          <!-- Area Commerciale -->
          <div class="col-md-6 mb-3">
            <label for="commercialeForm" class="form-label"
              >Area Commerciale</label
            >
            <input
              type="text"
              id="commercialeForm"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('commerciale')"
              formControlName="commerciale"
              placeholder="Es. Centro-Nord, Sud"
            />
            <div class="invalid-feedback" *ngIf="isFieldInvalid('commerciale')">
              {{ getFieldError('commerciale') }}
            </div>
          </div>

          <!-- Azienda -->
          <div class="col-md-6 mb-3">
            <label for="azienda" class="form-label">Azienda</label>
            <input
              type="text"
              id="azienda"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('azienda')"
              formControlName="azienda"
              placeholder="Es. Proxima S.r.l."
            />
            <div class="invalid-feedback" *ngIf="isFieldInvalid('azienda')">
              {{ getFieldError('azienda') }}
            </div>
          </div>

          <!-- Ruolo -->
          <div class="col-md-6 mb-3">
            <label for="ruolo" class="form-label">Ruolo</label>
            <input
              type="text"
              id="ruolo"
              class="form-control"
              [class.is-invalid]="isFieldInvalid('ruolo')"
              formControlName="ruolo"
              placeholder="Es. Developer, Manager"
            />
            <div class="invalid-feedback" *ngIf="isFieldInvalid('ruolo')">
              {{ getFieldError('ruolo') }}
            </div>
          </div>
        </div>

        <div class="text-muted small mb-3">* Campi obbligatori</div>
      </form>
    </div>

    <div class="modal-footer-content">
      <button
        type="button"
        class="btn btn-secondary me-2"
        (click)="closeModal()"
        [disabled]="isSubmitting"
      >
        Annulla
      </button>
      <button
        type="button"
        class="btn btn-primary"
        (click)="onSubmit()"
        [disabled]="isSubmitting || dipendenteForm.invalid"
      >
        <span
          *ngIf="isSubmitting"
          class="spinner-border spinner-border-sm me-2"
          role="status"
        ></span>
        {{ modalMode === 'add' ? 'Aggiungi' : 'Salva Modifiche' }}
      </button>
    </div>
  </app-modal>

  <!-- Notification Modal -->
  <app-notification-modal
    [isOpen]="notification.isOpen"
    [title]="notification.title"
    [message]="notification.message"
    [details]="notification.details"
    [type]="notification.type"
    (closed)="closeNotification()"
  >
  </app-notification-modal>

  <!-- Confirmation Modal -->
  <app-confirmation-modal
    [isOpen]="confirmation.isOpen"
    [title]="confirmation.title"
    [message]="confirmation.message"
    [details]="confirmation.details"
    [type]="confirmation.type"
    [isProcessing]="confirmation.isProcessing"
    confirmText="Conferma"
    cancelText="Annulla"
    (confirmed)="onConfirmationConfirmed()"
    (cancelled)="closeConfirmation()"
  >
  </app-confirmation-modal>
</div>
